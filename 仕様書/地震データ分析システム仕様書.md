# 地震データ分析システム仕様書

## 1. システム概要

### 1.1 目的
地震データを分析し、複数の指標に基づいてスコアを計算することで、地震活動の評価を行うシステムです。

### 1.2 処理フロー
```
生データ読み込み
    ↓
各スコア計算（並列処理可能）
    ├─ 国内地震スコア（japan_score）
    ├─ 世界地震スコア（world_score）
    └─ 深さスコア（depth_score）
    ↓
スコア統合
    ↓
総合スコア（total_score）出力
```

## 2. データソース

### 2.1 入力データファイル

#### 2.1.1 国内地震データ（2010-all.csv）
- **配置場所**: `生データ/2010-all.csv`
- **形式**: CSV
- **カラム構成**:
  - `date`: 日付（文字列形式）
    - 形式1: `12月9日`（年月が省略された形式、2010年と仮定）
    - 形式2: `2010/1/2`（YYYY/MM/DD形式）
  - `place`: 震源地（文字列）
  - `magnitude`: マグニチュード（数値）

#### 2.1.2 世界地震データ（world-all.csv）
- **配置場所**: `生データ/world-all.csv`
- **形式**: CSV
- **カラム構成**:
  - `date`: 日付（YYYY/MM/DD形式、パース可能）
  - `place_w`: 震源地（文字列）
  - `magnitude_w`: マグニチュード（数値）

#### 2.1.3 深さデータ（depth.csv）
- **配置場所**: `生データ/depth.csv`
- **形式**: CSV
- **カラム構成**:
  - `date`: 日付（YYYY/MM/DD形式、パース可能）
  - `depth`: 深さ（数値、単位: km）

**注意**: 気圧データ（atmospheric.csv）は今回の分析対象外です。

### 2.2 出力データファイル

**出力先フォルダ**: `データ分析結果出力/`

#### 2.2.1 国内地震スコア（japan_scores.csv）
- **出力先**: `データ分析結果出力/japan_scores.csv`
- **カラム**: `date`, `score`
- **説明**: 日毎の国内地震スコア

#### 2.2.2 世界地震スコア（world_scores.csv）
- **出力先**: `データ分析結果出力/world_scores.csv`
- **カラム**: `date`, `world_score`
- **説明**: 日毎の世界地震スコア

#### 2.2.3 深さスコア（depth_scores.csv）
- **出力先**: `データ分析結果出力/depth_scores.csv`
- **カラム**: `date`, `depth_score`
- **説明**: 日毎の深さスコア

#### 2.2.4 総合スコア（total.csv）
- **出力先**: `データ分析結果出力/total.csv`
- **カラム**: `date`, `total_score`
- **説明**: 3つのスコア（国内地震、世界地震、深さ）を統合した総合スコア

## 3. スコア計算ロジック

### 3.1 国内地震スコア（japan_score）

#### 3.1.1 基本設定
- **基準日**: 2010年2月1日
- **計算単位**: 日毎
- **対象データ**: 2010-all.csv

#### 3.1.2 スコア加算条件

| 条件 | スコア加算 | 説明 |
|------|-----------|------|
| 条件1 | +1.0 | 1日あたりのmagnitude数が3回以内が3日以上連続 |
| 条件2 | +2.0 | 1日あたりのmagnitude数が3回以内が6日以上連続 |
| 条件3 | +1.0 | 当日10回以上 & 過去30日全て6.5以下 |
| 条件4 | +0.5 | M5以上が5回以上 |
| 条件5 | +1.0 | M5以上が10回以上 |
| 条件6 | +1.0 | 特定地域での発生（日向灘、択捉島南東沖、薩摩半島西方沖、小笠原諸島西方沖、千島列島、鳥島近海、父島近海） |
| 急増スコア | +1.0 | 過去3日の平均発生回数の2倍以上 |
| 局所集中スコア | +1.0 | 同一地域で5回以上発生 |
| 前震候補スコア | +1.5 | M7発生前30日以内でM5〜M6.9が3回以上 |

#### 3.1.3 日付変換処理
- `12月9日`形式 → `2010年12月9日`として解釈
- `2010/1/2`形式 → そのままパース

### 3.2 世界地震スコア（world_score）

#### 3.2.1 基本設定
- **計算期間**: 各日を基準日として、過去30日間のデータを対象
- **対象データ**: world-all.csv

#### 3.2.2 スコア計算式
```
スコア = Σ(各地震のスコア) / 20

各地震のスコア:
- magnitude_w >= 6: +1
- magnitude_w >= 7: +2
- magnitude_w >= 8: +3
```

#### 3.2.3 計算範囲
- **開始日**: 2010年2月1日
- **終了日**: データの最大日付まで
- **日毎に計算**: 各日を基準日として過去30日間を評価

### 3.3 深さスコア（depth_score）

#### 3.3.1 基本設定
- **計算期間**: 各日を基準日として、過去30日間のデータを対象
- **対象データ**: depth.csv

#### 3.3.2 スコア計算式
```
スコア = Σ(各深さのスコア) / 20

各深さのスコア:
- depth >= 300: +1
- depth >= 400: +2
- depth >= 500: +3
```

#### 3.3.3 計算範囲
- **開始日**: 2010年2月1日
- **終了日**: データの最大日付まで
- **日毎に計算**: 各日を基準日として過去30日間を評価

**注意**: 気圧スコア（atmospheric_score）は今回の分析対象外です。

### 3.4 総合スコア（total_score）

#### 3.4.1 計算式
```
total_score = depth_score + world_score + japan_score
```

#### 3.4.2 マージ処理
- 3つのスコアファイル（depth_scores.csv, world_scores.csv, japan_scores.csv）を`date`カラムで外部結合（outer join）
- 欠損値は0で埋める（fillna(0)）

## 4. 技術仕様

### 4.1 ソースファイルの配置
- **配置場所**: `ソース/`
- データ前処理、分析、可視化のスクリプトは全てこのフォルダに配置する
- 機能ごとにフォルダで分類（例: `ソース/data_preprocessing/`, `ソース/analysis/`, `ソース/visualization/`）

### 4.2 グラフ作成
- **グラフの出力先**: `グラフ/`
- グラフ作成スクリプト: `ソース/create_graphs.py`
- **再利用可能な関数**:
  - `create_timeseries_graph()`: 時系列グラフを作成
  - `create_multiple_timeseries_graph()`: 複数の時系列データを比較
  - `create_histogram()`: ヒストグラムを作成
- グラフファイル名は内容が分かるように命名（例: `total_score_timeseries.png`）

### 4.3 使用ライブラリ
- pandas: データ処理
- datetime: 日付処理

### 4.4 データ型
- 日付: pandas.Timestamp
- スコア: float（浮動小数点数）

### 4.5 エラーハンドリング
- `magnitude`の数値変換エラーは`errors='coerce'`でNaNに変換
- 日付パースエラーは適切な形式に変換

### 4.6 パフォーマンス考慮事項
- 日毎のループ処理が必要（特に国内地震スコア）
- 大規模データセットの場合は処理時間に注意

## 5. 実装上の注意点

### 5.1 日付形式の統一
- 国内地震データは2つの異なる日付形式が混在
- `parse_japan_earthquake_date`関数で統一処理が必要

### 5.2 データの欠損
- 各スコアファイルのマージ時に欠損値処理が必要
- 日付が一致しない場合は0で埋める

### 5.3 基準日の設定
- 全スコア計算の基準日は2010年2月1日
- この日付より前のデータは処理対象外

### 5.4 特定地域の判定
- 国内地震スコアの条件6では、文字列マッチングを使用
- 地域名の表記揺れに注意が必要

## 6. 今後の拡張可能性

### 6.1 データソースの追加
- 他の地震関連データの統合
- リアルタイムデータ取得の実装

### 6.2 スコア計算ロジックの改善
- 機械学習モデルの導入
- 重み付けの最適化

### 6.3 可視化機能
- 時系列グラフの作成
- 地図上でのスコア表示
- ダッシュボードの構築

## 7. 確認事項

### 7.1 データ品質
- [ ] 日付形式の完全な統一確認
- [ ] マグニチュード値の妥当性確認
- [ ] 深さ値の単位確認（km想定）

### 7.2 出力先
- [x] スコアファイルの出力先フォルダの指定: `データ分析結果出力/`
- [ ] ファイル名の命名規則の統一

## 8. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2024-XX-XX | 1.1 | 気圧データ（atmospheric.csv）を対象外に変更 |
| 2024-XX-XX | 1.0 | 初版作成 |

