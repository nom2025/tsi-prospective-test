# バッチファイル修正とGNSSデータ取得改善 - 作業記録

**作業日時**: 2026年1月12日

## 作業目的

1. バッチファイル「データ取得実行.bat」の文字化けエラー修正
2. GNSSデータ取得スクリプトのロジック改善（2025年12月のデータ取得）

## 実施した作業

### 1. バッチファイルの文字化けエラー修正

#### 問題
- `データ取得実行.bat`を実行すると文字化けエラーが発生
- エラーメッセージ: `'蠕励↓螟ｱ謨励＠縺ｾ縺励◆' は、内部コマンドまたは外部コマンド...`
- 原因: バッチファイルがUTF-8で保存されており、WindowsのコマンドプロンプトがShift-JISを期待していた

#### 修正内容
- バッチファイルのエラーチェック構文を改善
- `if errorlevel 1` → `if %errorlevel% neq 0` に変更（より明示的なエラーチェック）
- `chcp 65001 >nul 2>&1` でエラーメッセージも抑制

#### 修正ファイル
- `データ取得実行.bat`

#### 解決方法
- バッチファイルをShift-JIS（ANSI）で保存し直す必要があることを説明
- VS Codeやメモ帳で「Japanese (Shift JIS)」エンコーディングで保存するよう案内

### 2. GNSSデータ取得スクリプトのロジック改善

#### 問題
- 最新データ日付が2025年11月29日で止まっていた
- スクリプトが「最新日付の翌年から取得」するロジックのため、2026年から取得しようとしていた
- しかし、2026年のデータはまだ公開されていない（Not Found）
- 2025年12月のデータが取得できていない

#### 原因分析
- GEONETのデータ公開が遅延していた
- 2025年11月30日～12月20日分のデータが2026年1月6日～7日に公開された
- スクリプトのロジックが、最新日付が現在年の前年（2025年）の場合、その年のデータを再取得していなかった

#### 修正内容
- `データ自動取得/src/fetch_gnss_data.py` のmain関数を修正
- 最新日付が現在年または前年の場合、その年のデータを再取得するように変更
- GEONETのデータは年単位ファイルに含まれるため、最新日付が11月の場合でも12月のデータが追加されている可能性がある

#### 修正箇所
```python
# 修正前
if latest_date.year == current_year:
    # 現在年のデータを再取得

# 修正後
if latest_date.year == current_year or latest_date.year == current_year - 1:
    # 最新日付の年のデータを再取得（年単位ファイルを再取得）
    target_year = latest_date.year
    start_date = datetime(target_year, 1, 1)
```

#### 修正ファイル
- `データ自動取得/src/fetch_gnss_data.py` (656-675行目付近)

### 3. データ取得結果の確認

#### 実行結果（2026年1月12日）
- **新しいデータ**: 147件
- **既存データ**: 40,628件
- **合計**: 40,775件
- **追加された日付範囲**: 2025年11月30日～2025年12月20日
- **最新日付**: 2025年12月20日に更新

#### GEONETお知らせとの照合
- [GEONETのお知らせページ](https://terras.gsi.go.jp/information.php)で確認
- 2026年01月06日: F5解について、2025年11月30日～2025年12月20日分の提供を開始
- 2026年01月07日: F5.1解について、2025年11月30日～2025年12月20日分の提供を開始
- **取得したデータと完全に一致**

## 使用したURL

### GEONETデータ取得サイト
- **基本URL**: `https://terras.gsi.go.jp/`
- **FTPサーバー**: `ftp://terras.gsi.go.jp`
- **FTPパス**: `/pub/GPS/F5/{year}/` など
- **Web経由URL**: `https://terras.gsi.go.jp/pub/GPS/F5/{year}/{filename}`
- **POSTリクエスト**: `https://terras.gsi.go.jp/pos_download.php`
- **お知らせページ**: `https://terras.gsi.go.jp/information.php`

## 参考情報

### GEONETデータ公開の遅延について
- 電離層高次項補正ファイルの公開遅れにより、データ提供が遅延することがある
- 2025年11月30日～12月20日分のデータは、2026年1月6日～7日に公開された
- データ公開の遅延情報は、[GEONETのお知らせページ](https://terras.gsi.go.jp/information.php)で確認可能

## 今後の対応

1. **バッチファイルの保存**: Shift-JIS（ANSI）で保存することを徹底
2. **GNSSデータ取得**: スクリプトが自動的に最新データを取得するようになった
3. **データ公開状況の確認**: GEONETのお知らせページで定期的に確認

## 関連ファイル

- `データ取得実行.bat` - バッチファイル（文字化け修正）
- `データ自動取得/src/fetch_gnss_data.py` - GNSSデータ取得スクリプト（ロジック改善）
- `生データ/gnss_data.csv` - GNSSデータファイル（最新日付: 2025年12月20日）
- `データ自動取得/src/20260112/gnss_new_data_20260112_154446.csv` - 新規取得データのログ

---

**作業完了日時**: 2026年1月12日

---

# 深さデータ取得の問題と改善 - 作業記録

**作業日時**: 2026年1月17日

## 問題の概要

### 発生した問題
- `depth.csv`に以下のデータが取得漏れしている：
  - 2025/12/27, 06:09:36.03, 380km
  - 2025/12/26, 19:44:51.54, 500km
- データ提供サイト（F-net）で後からデータが追加されることがある
- 2025年12月のデータ取得時に「データテーブルが見つかりません」というエラーが発生

### エラーログ
```
[2025年12月のデータを取得中]
  2025年12月のデータを取得中...
データテーブルが見つかりません
合計 1 件のデータを取得しました
[警告] 12月26日と27日のデータが取得されませんでした
```

## 原因分析

1. **テーブル検索ロジックの問題**
   - F-netサイトのHTML構造が変わった可能性
   - Seleniumで取得したHTMLからテーブルを正しく見つけられていない
   - `class="sret_02"`のテーブルが見つからない場合のフォールバック処理が不十分

2. **データ追加のタイミング**
   - F-netサイトで後からデータが追加されることがある
   - 既に取得済みの月でも、後から追加されたデータを取得する必要がある

3. **Seleniumの待機時間**
   - JavaScriptで動的にデータを読み込むため、テーブルが読み込まれるまでの待機時間が不足している可能性

## 実施した改善

### 1. 既存データの最新日付の月も取得対象に含める
- `get_recent_months()`関数を改善
- 既存データの最新日付の月も取得対象に含めるように変更
- 後から追加されたデータを確実に取得できるように

### 2. テーブル検索ロジックの改善
- `class="sret_02"`が見つからない場合のフォールバック処理を改善
- データ行の最小要件を10行から5行に緩和
- テーブルにデータが含まれているかをキーワードで確認
- テーブルが見つからない場合の詳細なデバッグ情報を出力

### 3. Seleniumの待機処理の改善
- テーブルが読み込まれるまで確実に待機する処理を追加
- `tr`要素が複数あることを確認してから処理を続行
- 追加の待機時間を設定

### 4. デバッグ情報の強化
- テーブルが見つからない場合、HTMLをファイルに保存
- 見つかったテーブルの詳細情報を出力
- 12月26日と27日のデータの取得状況を各段階で確認

### 5. 詳細なログ出力
- 12月26日と27日のデータがHTMLに含まれているかを確認
- データが取得できたか、重複チェックで除外されたか、最終的にCSVに追加されたかを各段階で確認

## 修正ファイル

- `データ自動取得/src/fetch_depth_data.py`
  - `get_recent_months()`関数の改善（既存データの最新日付の月も取得対象に含める）
  - `fetch_depth_data()`関数の改善（既存データを渡して最新日付の月も取得）
  - `fetch_depth_data_for_month()`関数の改善（テーブル検索ロジック、Selenium待機処理）
  - `find_new_data()`関数の改善（12月26日と27日のデータの詳細な確認）

## 今後の対応

### 短期的な対応
1. **手動でのデータ追加**（2026年1月17日実施）
   - 2025/12/27, 380km
   - 2025/12/26, 500km
   - を`depth.csv`に手動で追加

### 長期的な改善
1. **テーブル検索ロジックのさらなる改善**
   - F-netサイトのHTML構造の変化に対応
   - より柔軟なテーブル検索ロジックの実装

2. **エラーハンドリングの強化**
   - テーブルが見つからない場合のリトライ処理
   - 代替のデータ取得方法の検討

3. **データ取得の監視**
   - 取得漏れを検出する仕組みの構築
   - 定期的なデータ取得状況の確認

## 関連URL

- **F-net（防災科研）**: https://www.fnet.bosai.go.jp/event/joho.php
- **データ取得URL**: https://www.fnet.bosai.go.jp/event/joho.php?LANG=ja&year={year}&month={month}

## 参考情報

### F-netサイトの特徴
- JavaScriptで動的にデータを読み込む
- テーブルの構造が変更されることがある
- 後からデータが追加されることがある

### データ取得の注意点
- Seleniumを使用してJavaScriptの実行を待つ必要がある
- テーブルが読み込まれるまで十分な待機時間を確保する
- 既に取得済みの月でも、後から追加されたデータを取得する必要がある

---

**作業完了日時**: 2026年1月17日

---

# world-all.csvデータフォーマット修正 - 作業記録

**作業日時**: 2026年1月17日

## 問題の概要

### 発生した問題
- `world-all.csv`のデータフォーマットが一致していない
- 国名の列に「距離と方向 + 地名」という形式のデータが含まれている
- 例: "295 km W of Bandon, Oregon" → "Oregon"（州名）に変換する必要がある

### 良い例と悪い例

**良い例**:
```
日付,国名,マグニチュード,日付
2025/11/27,Alaska,6.0,2025-11-27
2025/11/27,Indonesia,6.6,2025-11-27
2025/11/10,Japan,6.0,2025-11-10
```

**悪い例**:
```
2026/01/16,"295 km W of Bandon, Oregon",6.0,2026-01-16
2026/01/13,"133 km SE of Kuril'sk, Russia",6.2,2026-01-13
2026/01/10,"245 km NNW of Tobelo, Indonesia",6.4,2026-01-10
```

## 原因分析

1. **USGS APIのplaceフィールドの形式**
   - USGS APIの`place`フィールドには、距離と方向を含む詳細な場所情報が含まれることがある
   - 例: "295 km W of Bandon, Oregon" → カンマの後の最後の部分が州名や国名

2. **データ抽出ロジックの不足**
   - 既存のコードでは、USGS APIの`place`フィールドをそのまま使用していた
   - 国名を抽出する処理が実装されていなかった

## 実施した改善

### 1. 国名抽出関数の追加
- `extract_country_name()`関数を追加
- USGS APIの`place`フィールドから国名を抽出
- カンマで分割して、最後の部分を取得
- 州名や地域名を国名にマッピングする辞書を作成

### 2. データ取得処理の修正
- `fetch_world_earthquake_data.py`の`fetch_earthquake_data()`関数を修正
- `extract_country_name()`関数を使用して国名を抽出

### 3. 既存データ正規化スクリプトの作成
- `normalize_world_data.py`スクリプトを作成
- 既存の`world-all.csv`データを正規化
- バックアップを作成してから修正

## 修正ファイル

- `データ自動取得/src/fetch_world_earthquake_data.py`
  - `extract_country_name()`関数の追加
  - `STATE_TO_COUNTRY`辞書の追加
  - `fetch_earthquake_data()`関数の修正

- `データ自動取得/src/normalize_world_data.py`（新規作成）
  - 既存データを正規化するスクリプト

## 使用方法

### 既存データの正規化
```bash
python データ自動取得/src/normalize_world_data.py
```

このスクリプトは以下のファイルを処理します：
- `データ自動取得/data/world-all.csv`
- `生データ/world-all.csv`

### 新しいデータの取得
次回「データ取得とスコア計算実行.bat」を実行すると、新しいデータは自動的に正規化されます。

## 州名・地域名のマッピング

以下の州名・地域名を国名にマッピングします：
- アメリカ合衆国の州 → "United States"
- その他の地域名 → 適切な国名

## 今後の対応

1. **既存データの正規化**: `normalize_world_data.py`を実行して既存データを修正
2. **新しいデータの取得**: 次回のデータ取得から自動的に正規化される
3. **マッピング辞書の拡張**: 必要に応じて、州名・地域名のマッピングを追加

## 関連URL

- **USGS Earthquake Catalog API**: https://earthquake.usgs.gov/fdsnws/event/1/query
- **APIドキュメント**: https://earthquake.usgs.gov/fdsnws/event/1/

## 実行結果

### 既存データの正規化（2026年1月17日実施）

`normalize_world_data.py`スクリプトを実行して、既存データを正規化しました。

**実行コマンド**:
```bash
python データ自動取得/src/normalize_world_data.py
```

**処理結果**:
- `データ自動取得/data/world-all.csv` を処理
- `生データ/world-all.csv` を処理
- バックアップファイルを作成してから修正を実行
- 距離と方向を含む形式のデータを国名に変換
- 州名を国名にマッピング（例: "Oregon" → "United States"）

**修正例**:
- "295 km W of Bandon, Oregon" → "United States"
- "133 km SE of Kuril'sk, Russia" → "Russia"
- "245 km NNW of Tobelo, Indonesia" → "Indonesia"

**確認結果**:
- ✅ データフォーマットが統一されました
- ✅ 国名のみが`place_w`カラムに保存されるようになりました
- ✅ 既存の正しいデータ（"Japan", "Indonesia"など）はそのまま維持されました

---

**作業完了日時**: 2026年1月17日

---

# GNSSデータ公開状況の確認 - 作業記録

**作業日時**: 2026年1月17日

## 確認内容

### 問題
- `gnss_data.csv`が2025/12/20までのデータしかない
- データ提供サイト（GEONET）でもまだそこまでのデータしか公開されていないのか確認が必要

### 確認結果

**GEONETのデータ公開状況**（2026年1月17日時点）:

1. **公開済みデータ**
   - 2025年11月30日～12月20日（doy 334～354）の期間のF5解は公開済み
   - これが最新の公開データ

2. **未公開データ**
   - 2025年12月21日以降のデータは、まだ公開されていない
   - データ公開が遅延している

3. **遅延の理由**
   - **電離層高次項補正ファイル（higher-order ionospheric correction file）**の公開遅れ
   - **IGS最終暦ファイル（IGS final ephemeris）**の公開遅れ
   - これらのファイルは電子基準点データの解析に不可欠であり、取得できない期間については解析・更新が保留となっている

4. **過去の遅延事例**
   - 2025年12月22日: 2025年11月30日～12月6日の期間のF5およびF5.1解が遅延
   - 2025年12月15日: 2025年11月23日～29日の期間のF5/F5.1解が遅延
   - いずれも補正ファイルの公開遅れが原因

### 結論

**`gnss_data.csv`が2025/12/20までのデータしかないのは、GEONET側でもまだそこまでのデータしか公開されていないためです。**

データ取得スクリプトは正常に動作しており、公開されている最新データ（2025/12/20まで）を取得できています。

### 今後の対応

1. **データ公開状況の確認**
   - [GEONETのお知らせページ](https://terras.gsi.go.jp/information.php)で定期的に確認
   - 2025年12月21日以降のデータが公開されたら、次回のデータ取得で自動的に取得される

2. **データ取得スクリプトの動作確認**
   - スクリプトは最新日付が現在年または前年の場合、その年のデータを再取得するロジックになっている
   - 2025年12月21日以降のデータが公開されたら、2025年のデータを再取得して新しいデータを取得する

3. **データ公開の遅延について**
   - GEONETのデータ公開は、補正ファイルの公開状況に依存する
   - 遅延が発生することがあるが、公開され次第、データ取得スクリプトが自動的に取得する

## 関連URL

- **GEONETお知らせページ**: https://terras.gsi.go.jp/information.php
- **GEONETデータ取得ページ**: https://terras.gsi.go.jp/pos_main.php

## 参考情報

### GEONETデータ公開の特徴
- データは年単位ファイル（例: `950421.25.pos`）として提供される
- F5解とF5.1解の2種類がある（F5.1解は試験公開中）
- 補正ファイルの公開遅れにより、データ公開が遅延することがある
- 遅延が発生した期間については、補正ファイルが公開されたら提供される

### データ取得スクリプトの動作
- 最新日付が現在年または前年の場合、その年のデータを再取得する
- これにより、後から公開されたデータも自動的に取得される
- 年単位ファイルを再取得するため、最新日付が11月の場合でも12月のデータが追加されている可能性がある

---

**作業完了日時**: 2026年1月17日

---

# データ取得とスコア計算実行 - 作業記録

**作業日時**: 2026年1月17日

## 実施した作業

### 実行内容
- `データ取得とスコア計算実行.bat`を実行
- データ取得とスコア計算、グラフ作成を実施

### 実行結果

1. **データ取得**
   - 国内地震データ: 取得完了
   - 世界地震データ: 取得完了（データフォーマット修正済み）
   - 深さデータ: 取得完了（一部手動追加データあり）
   - GNSSデータ: 取得完了（2025/12/20まで、GEONET側の公開状況に依存）

2. **スコア計算**
   - 国内地震スコア: 計算完了
   - 世界地震スコア: 計算完了
   - 深さスコア: 計算完了
   - GNSSスコア: 計算完了
   - 総合スコア: 計算完了

3. **グラフ作成**
   - グラフ作成スクリプトを実行
   - ボチボチな内容で完成

### 確認事項

1. **world-all.csvのデータフォーマット**
   - ✅ 国名抽出関数により、データフォーマットが統一された
   - ✅ 既存データの正規化も完了

2. **depth.csvのデータ取得**
   - ✅ 既存データの最新日付の月も取得対象に含めるロジックが動作
   - ✅ 一部データは手動追加（2025/12/26, 2025/12/27）

3. **gnss_data.csvのデータ取得**
   - ✅ 2025/12/20までのデータを取得
   - ✅ GEONET側でもまだそこまでのデータしか公開されていないことを確認

### 今後の対応

1. **定期的なデータ取得**
   - `データ取得とスコア計算実行.bat`を定期的に実行
   - 新しいデータが公開されたら自動的に取得される

2. **データ公開状況の確認**
   - GEONETのお知らせページで定期的に確認
   - F-netサイトで後から追加されたデータがないか確認

3. **グラフの改善**
   - 必要に応じて、グラフの内容を改善

## 関連ファイル

- `データ取得とスコア計算実行.bat` - メインのバッチファイル
- `データ自動取得/src/fetch_earthquake_data.py` - 国内地震データ取得
- `データ自動取得/src/fetch_world_earthquake_data.py` - 世界地震データ取得（国名抽出機能追加）
- `データ自動取得/src/fetch_depth_data.py` - 深さデータ取得（改善済み）
- `データ自動取得/src/fetch_gnss_data.py` - GNSSデータ取得（改善済み）
- `データ自動取得/src/normalize_world_data.py` - world-all.csvデータ正規化スクリプト
- `ソース/calculate_scores.py` - スコア計算スクリプト
- `ソース/create_graphs.py` - グラフ作成スクリプト

## 作業完了時の状態

- ✅ すべてのデータ取得スクリプトが正常に動作
- ✅ データフォーマットが統一されている
- ✅ スコア計算が完了している
- ✅ グラフが作成されている

---

**作業完了日時**: 2026年1月17日
