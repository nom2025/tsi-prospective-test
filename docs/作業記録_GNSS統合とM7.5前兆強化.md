# 作業記録: GNSS統合とM7.5前兆強化

## 実施日
2025年1月（推定）

## 実施内容

### 1. GNSSデータ取得の統合

#### 1.1 GNSSデータ取得スクリプトの追加
- **ファイル**: `データ自動取得/src/fetch_gnss_data.py`
- **機能**: 国土地理院GEONETからGNSSデータを取得
- **対象観測地点**: 7地点（東京、横浜、静岡、名古屋、大阪、神戸、広島）
- **データ形式**: `date,station_id,station_name,latitude,longitude,east_mm,north_mm,up_mm`

#### 1.2 データ取得実行.batへの追加
- **ファイル**: `データ自動取得/データ取得実行.bat`
- **変更内容**: GNSSデータ取得ステップを追加（[4/4]）
- **実行順序**:
  1. 国内地震データ取得
  2. 世界地震データ取得
  3. 深さデータ取得
  4. GNSSデータ取得（新規追加）

#### 1.3 生データフォルダへの自動コピー
- **実装**: `fetch_gnss_data.py`の`main()`関数内
- **動作**: データ更新時に自動的に`生データ/gnss_data.csv`にコピー
- **処理タイミング**:
  - 新しいデータがない場合でも既存データをコピー
  - 新しいデータがある場合は更新データをコピー

#### 1.4 データ取得の最適化
- **実装**: 既存データの最新日付を確認して、それ以降のデータのみを取得
- **関数**: `get_latest_date_from_csv()`を追加
- **動作**: 最新日付の翌年から取得（GNSSデータは年単位で提供されるため）

### 2. スコア計算へのGNSS統合

#### 2.1 GNSSスコア計算関数の追加
- **ファイル**: `ソース/calculate_scores.py`
- **追加関数**:
  - `calculate_daily_displacement()`: 日々の変動量を計算
  - `calculate_gnss_score()`: GNSSスコアを計算
- **スコア計算ロジック**:
  - 変動量スコア: 最大変動量に応じて0.5〜2.0点
  - 継続性スコア: 連続変動日数に応じて0.5〜2.0点
  - 同時変動スコア: 複数地点の同時変動に応じて1.0〜2.0点

#### 2.2 総合スコアへの統合
- **変更前**: 総合スコア = 国内 + 世界 + 深さ
- **変更後**: 総合スコア = 国内 + 世界 + 深さ + GNSS
- **出力ファイル**: `データ分析結果出力/total.csv`

### 3. M7.5以上の前兆検出強化

#### 3.1 国内地震スコアの強化
- **M7.5前兆パターンの追加**:
  - 前30日の平均Mが3.0〜3.5で発生回数が急増する場合にスコア加算（+1.5）
  - M7.5発生前30日以内の前震候補スコアを強化（重み2.0）
- **M7前兆パターン**: 既存のM7前兆パターンも維持（重み1.5）

#### 3.2 世界地震スコアの強化
- **M7.5以上の重み増加**: M7.5以上で追加スコアを加算（+2/20）
- **世界M7発生後の国内地震リスク**: 世界M7発生後7日間はスコア加算（+1.0）

### 4. グラフ作成の拡張

#### 4.1 GNSSスコアのグラフ表示対応
- **ファイル**: `ソース/create_graphs.py`
- **変更内容**: GNSSスコアのラベルマップを追加
- **出力グラフ**: `all_scores_comparison.png`にGNSSスコアを含める

#### 4.2 凡例位置の設定ファイル対応
- **設定ファイル**: `グラフ/legend_config.csv`
- **設定項目**:
  - `legend_loc`: 凡例の基本位置（upper right, upper left等）
  - `bbox_x`: X座標（0.0〜1.0）
  - `bbox_y`: Y座標（0.0〜1.0）
- **使用方法**: CSVファイルを編集して`グラフ作成実行.bat`を実行

#### 4.3 Excel形式での出力
- **出力ファイル**: `グラフ/total_score_data.xlsx`
- **機能**: Excelでグラフを編集可能、PowerPointにコピー&ペースト可能
- **必要ライブラリ**: openpyxl（`pip install openpyxl`）

### 5. バッチファイルの更新

#### 5.1 スコア計算実行.bat
- **変更内容**: GNSSスコアの出力先を追加
- **出力メッセージ**: GNSSスコアを含むことを明記

#### 5.2 グラフ作成実行.bat
- **注意**: 文字エンコーディングの問題により、手動での作成が必要な場合あり
- **代替方法**: Pythonスクリプトを直接実行可能

## ファイル構成

### 追加・変更されたファイル

#### データ自動取得
- `データ自動取得/src/fetch_gnss_data.py`（新規）
- `データ自動取得/データ取得実行.bat`（更新）

#### ソース
- `ソース/calculate_scores.py`（更新: GNSS統合、M7.5前兆強化）
- `ソース/create_graphs.py`（更新: GNSS対応、凡例設定対応、Excel出力）

#### グラフ
- `グラフ/legend_config.csv`（新規: 凡例位置設定）
- `グラフ/凡例位置設定方法.md`（新規: 設定方法の説明）
- `グラフ/グラフ作成実行.bat`（更新: 文字エンコーディング問題あり）

#### データ分析結果出力
- `データ分析結果出力/スコア計算実行.bat`（更新: GNSSスコア出力先追加）

## 実行方法

### データ取得
```bash
# 方法1: バッチファイル実行（推奨）
データ自動取得\データ取得実行.bat

# 方法2: Pythonスクリプト直接実行
python データ自動取得\src\fetch_gnss_data.py
```

### スコア計算
```bash
# 方法1: バッチファイル実行（推奨）
データ分析結果出力\スコア計算実行.bat

# 方法2: Pythonスクリプト直接実行
python ソース\calculate_scores.py
```

### グラフ作成
```bash
# 方法1: バッチファイル実行（文字エンコーディング問題がある場合は方法2を使用）
グラフ\グラフ作成実行.bat

# 方法2: Pythonスクリプト直接実行（推奨）
python ソース\create_graphs.py
```

## 出力ファイル

### スコアCSV
- `データ分析結果出力/japan_scores.csv`
- `データ分析結果出力/world_scores.csv`
- `データ分析結果出力/depth_scores.csv`
- `データ分析結果出力/gnss_scores.csv`（新規）
- `データ分析結果出力/total.csv`（GNSSスコアを含む総合スコア）

### グラフ
- `グラフ/total_score_timeseries.png`（M7.5以上の地震表示）
- `グラフ/total_score_histogram.png`
- `グラフ/all_scores_comparison.png`（GNSSスコアを含む）
- `グラフ/total_score_data.xlsx`（Excel形式、編集可能）

## 注意事項

### バッチファイルの文字エンコーディング
- `グラフ/グラフ作成実行.bat`は文字エンコーディングの問題が発生する場合あり
- その場合はPythonスクリプトを直接実行することを推奨
- または、`データ分析結果出力/スコア計算実行.bat`をコピーして修正

### 必要なライブラリ
- **Excel出力機能**: `openpyxl`が必要（`pip install openpyxl`）
- インストールされていない場合は、Excel出力はスキップされる

### 凡例位置の調整
- `グラフ/legend_config.csv`を編集して凡例位置を調整可能
- 詳細は`グラフ/凡例位置設定方法.md`を参照

## 今後の改善点

1. バッチファイルの文字エンコーディング問題の解決
2. Excel出力機能の拡張（M7.5以上の地震マーカーを含める）
3. PowerPoint形式での直接出力機能の追加

