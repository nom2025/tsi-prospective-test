# 地震スコア分析システム - CONTEXT.md

## 更新履歴

| 日付 | 作業者 | 内容 |
|-|-|-|
| 2026/01/24 | Claude Opus 4.5 | b値スコア実装、グラフ改善（M7表示、外国地震除外）、精度評価まとめ |
| 2026/01/24 | Claude Opus 4.5 | depth.csv取得改善、GNSSあり/なし分離、グラフ改善、M7相関分析 |
| 2026/01/23 | Claude Opus 4.5 | 初版作成：ファイル整理、現況ドキュメント作成 |

---

## プロジェクト概要

地震データを分析し、複数の指標（国内地震、世界地震、深発地震、GNSS、b値）に基づいてスコアを計算することで、M7以上の大規模地震の前兆パターンを検出するシステム。

**検出精度**:
- 検出率（Recall）: **約94.9%**（39件中37件）
- 適合率（Precision）: **約10-20%**（推定）
- 偽陽性率: **約80-90%**

**重要な発見**:
- GNSSデータは総合スコアの約67%を占める重要な指標
- b値の低下は大地震の前兆の可能性を示唆（一部の地震で検出成功）

---

## 完了したタスク（2026/01/24 午後）

### 1. b値スコアの実装

**実装内容:**
- グーテンベルク・リヒター則に基づくb値計算（Aki-Utsu法）
- ベースラインからの相対的な低下をZ値で評価

**計算式:**
```python
b = log10(e) / (mean_M - (Mc - delta_M/2))
# Mc = 2.0（完全性限界）
# delta_M = 0.1（気象庁データの離散間隔）
```

**スコアリング:**
| Z値 | スコア | リスクレベル |
|-|-|-|
| 2σ以上低い | +2.0 | 高リスク |
| 1.5σ以上低い | +1.5 | 中〜高リスク |
| 1σ以上低い | +1.0 | 中リスク |
| 0.5σ以上低い | +0.5 | 低リスク |

**ベースライン統計:**
- 平均b値: 0.295
- 標準偏差: 0.036

**検出実績:**
| 地震 | b値スコア |
|-|-|
| 2011年4月余震群 | 最大2.0 |
| 2022年3月福島県沖M7.3 | 最大1.0 |
| 2016年4月熊本地震M7.3 | 最大1.0 |

**修正ファイル:** `ソース/calculate_scores.py`
- `calculate_b_value()` 関数追加
- `calculate_b_value_score()` 関数追加
- `calculate_baseline_b_value()` 関数追加
- 総合スコアにb値スコアを統合

### 2. グラフ表示の改善

**変更内容:**
- M7.5以上 → M7以上に閾値変更
- 外国地震を除外（日本国内のみ表示）

**除外する地域キーワード:**
```python
exclude_keywords = [
    '台湾', 'カムチャツカ', 'カムチャッカ', '小笠原諸島西方沖',
    'フィリピン', '南米', 'チリ', 'ペルー', 'インドネシア',
    'パプアニューギニア', 'ソロモン', 'バヌアツ', 'トンガ',
    'ニュージーランド', 'アラスカ', 'メキシコ', '中国',
    '千島列島', '択捉島南東沖'
]
```

**修正ファイル:** `ソース/create_graphs.py`
- `min_magnitude` を7.5から7.0に変更
- 外国地震除外フィルター追加
- ラベルを「M7以上」に変更

### 3. UnicodeEncodeErrorの修正

**問題:** Windows cp932エンコーディングでUnicode文字（✓, ✗, ⚠）が出力できない

**解決:**
- ✓ → [OK]
- ✗ → [NG]
- ⚠ → [!]

**修正ファイル:** `ソース/calculate_scores.py`, `ソース/create_graphs.py`

### 4. ドキュメント更新

**修正ファイル:** `docs/プロジェクト状態.md`
- GNSSデータ情報を追加
- b値スコア情報を追加
- 出力ファイル一覧を更新
- 実行方法を更新

---

## システム精度の評価

### 類似研究との比較

| 研究/システム | 手法 | 検出率 | 適合率 |
|-|-|-|-|
| Nanjo et al. (2012) | b値マッピング | 60-70% | 5-15% |
| Mignan (2014) | ETAS + b値 | 50-80% | 10-20% |
| Rundle et al. (2016) | 機械学習 | 85% | 15-25% |
| **このシステム** | **複合スコア** | **~95%** | **~10-20%** |
| MEGA地震予測（村井氏） | GNSS | 議論あり | 議論あり |

### 評価まとめ

| 観点 | 評価 |
|-|-|
| 手法の妥当性 | ○ 学術的に認められた手法を使用 |
| 実装の正確性 | ○ b値、Z値の計算は正しい |
| 予測精度 | △ 偽陽性が多い（他の研究と同程度） |
| 科学的厳密性 | × 検証プロセスが不足 |
| 実用性 | △ 「警戒の目安」としては有用 |

### 根本的な限界

**「短期的な地震予測は、現在の科学では実現できていない」** が世界的な学術コンセンサス。

問題点:
1. **パターン依存性**: 過去と同じパターンの地震は検出できるが、新しいパターンは検出困難
2. **物理モデルの欠如**: 地震発生のメカニズムが完全に解明されていない
3. **交差検証なし**: 過学習の可能性を排除できていない
4. **統計的検定なし**: 偶然との区別が未検証

---

## 現在のフォルダ構造

```
52-2_cursor_地震/
├── 1_データ取得実行.bat
├── 2a_スコア計算実行_GNSSあり.bat
├── 2b_スコア計算実行_GNSSなし.bat
├── CONTEXT.md                    # このファイル
│
├── ソース/
│   ├── calculate_scores.py      # スコア計算（b値追加、--no-gnss対応）
│   ├── create_graphs.py         # グラフ作成（M7表示、外国除外）
│   ├── explore_features.py      # 特徴探索
│   └── analyze_earthquake_correlation.py  # 相関分析
│
├── データ自動取得/
│   └── src/
│       ├── fetch_depth_data.py   # F-net深発地震（6ヶ月取得）
│       ├── fetch_gnss_data.py    # GNSSデータ取得
│       ├── fetch_earthquake_data.py
│       └── fetch_world_earthquake_data.py
│
├── 生データ/
│   ├── 2010-all.csv              # 国内地震データ
│   ├── world-all.csv             # 世界地震データ
│   ├── depth.csv                 # 深発地震データ
│   └── gnss_data.csv             # GNSSデータ
│
├── データ分析結果出力/
│   ├── japan_scores.csv
│   ├── world_scores.csv
│   ├── depth_scores.csv
│   ├── gnss_scores.csv
│   ├── b_value_scores.csv        # ★新規：b値スコア
│   ├── total_with_gnss.csv       # 総合スコア（GNSS込み）
│   ├── total_no_gnss.csv         # 総合スコア（GNSS除外）
│   └── 特徴探索結果/
│
├── グラフ/
│   ├── total_score_timeseries_with_gnss.png
│   ├── total_score_timeseries_no_gnss.png  # M7以上表示
│   ├── total_score_histogram_*.png
│   └── all_scores_comparison_*.png
│
└── docs/
    ├── プロジェクト状態.md       # プロジェクト状態（更新済）
    └── ...
```

---

## 技術的な注意点

### 1. b値計算の注意点

```python
# Aki-Utsu法（離散補正あり）
def calculate_b_value(magnitudes, mc=2.0):
    filtered = [m for m in magnitudes if m >= mc]
    if len(filtered) < 10:  # 最低10個必要
        return None
    delta_m = 0.1
    mean_m = np.mean(filtered)
    mc_corrected = mc - delta_m / 2
    if mean_m <= mc_corrected:
        return None
    b = np.log10(np.e) / (mean_m - mc_corrected)
    return b
```

**注意:**
- Mc（完全性限界）は2.0に設定（気象庁データ向け）
- 最低10個のデータが必要（統計的信頼性）
- 30日ウィンドウで計算

### 2. GNSSデータの制約

- **更新遅延:** データ提供サイトの更新が遅延
- **影響度:** GNSSスコアは総合スコアの約67%を占める
- **推奨:** 最新データでは `--no-gnss` モードを使用

### 3. Windows環境での文字コード

**問題:** cp932でUnicode文字が出力できない
**対策:** ✓→[OK], ✗→[NG], ⚠→[!] に置換済み

### 4. 総合スコアの構成

```python
total_score = (
    depth_score +      # 深発地震スコア
    world_score +      # 世界地震スコア
    japan_score +      # 国内地震スコア
    gnss_score +       # GNSSスコア（--no-gnssで0）
    b_value_score      # b値スコア（★新規）
)
```

---

## 次のアクション

### 精度向上のための検討事項（未実装）

1. **交差検証の実装**
   - 過学習の検証
   - 将来予測の検証

2. **前震クラスタリングの強化**
   - 同一地域で3日以内にM4以上が3回以上 → +2.0

3. **静穏期→急増パターン**
   - 7日間の静穏期後に急増 → 高スコア

4. **地域別重み付け**
   - 南海トラフ、相模トラフなどにリスク係数

5. **短期窓の追加**
   - 7日窓、14日窓の追加

### 実用上の注意

**このシステムは「地震予測」ではなく「警戒の目安」として使用すること。**

- 偽陽性が多い（スコアが高くても地震が来ないことが多い）
- 偽陰性もある（スコアが低くても地震が来ることがある）
- 過去のパターンに依存しており、新しいパターンは検出困難

---

## 実行方法

### データ取得のみ
```bash
1_データ取得実行.bat
```

### スコア計算（GNSSあり）
```bash
2a_スコア計算実行_GNSSあり.bat
# または
python ソース/calculate_scores.py
python ソース/create_graphs.py
```

### スコア計算（GNSSなし）- 最新データ推奨
```bash
2b_スコア計算実行_GNSSなし.bat
# または
python ソース/calculate_scores.py --no-gnss
python ソース/create_graphs.py --no-gnss
```

---

## 重要ファイル

| ファイル | 説明 |
|-|-|
| `ソース/calculate_scores.py` | スコア計算（b値追加、--no-gnss対応） |
| `ソース/create_graphs.py` | グラフ作成（M7表示、外国除外） |
| `データ分析結果出力/b_value_scores.csv` | b値スコア出力 |
| `docs/プロジェクト状態.md` | プロジェクト状態詳細 |

---

*最終更新: 2026/01/24*
